<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="Belleè¨˜å¸³æœ¬"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="theme-color" content="#cec6f3"/>
<meta name="description" content="Belleçš„æ¯æ—¥è¨˜å¸³æœ¬ - è¼•é¬†ç®¡ç†æ¯æœˆæ”¯å‡º"/>
<link rel="manifest" href="manifest.json"/>
<link rel="apple-touch-icon" href="icon-192.png"/>
<title>Belleçš„æ¯æ—¥è¨˜å¸³</title>
<style>
:root{
  --bg:#cec6f3;
  --card:hsl(271, 69%, 90%);
  --text:#7e61e7;
  --muted:#7842f8;
  --primary:lch(18.29% 33.41 308.02 / 0.827);
  --border:#9e6dfa;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue","PingFang TC","Noto Sans TC",Arial,sans-serif;color:var(--text)}
.container{max-width:980px;margin:24px auto;padding:0 16px}
h1{font-size:28px;margin:8px 0 16px}
.tabs{display:flex;gap:8px;margin:8px 0 16px}
.tab{padding:10px 16px;border-radius:24px;background:#eaf2ff;color:#6b27e9;border:1px solid #dbe7ff;cursor:pointer}
.tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 2px 4px rgba(15,33,55,.04)}
.section-title{font-weight:800;font-size:20px;margin:0 0 12px;display:flex;align-items:center;gap:8px}
input,select,button,textarea{font-size:16px}
.input{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#f9fbff}
#monthInput{cursor:pointer !important; user-select:none; -webkit-user-select:none;}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 240px}
.btn{background:var(--primary);color:#fff;border:none;border-radius:12px;padding:10px 16px;cursor:pointer}
.btn.secondary{background:#b99bf0;color:#7d42eb}
.inline{display:flex;gap:8px;align-items:center}
.badge{display:inline-block;border:1px dashed #5b389b;border-radius:12px;padding:14px 18px;min-width:140px;text-align:center}
.badge .label{font-size:14px;color:var(--muted)}
.badge .num{font-size:28px;font-weight:800;margin-top:4px}
.table{width:100%;border-collapse:separate;border-spacing:0 10px}
.table th,.table td{background:#fff;border:1px solid var(--border);padding:12px 14px;white-space:nowrap}
.table th:first-child,.table td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
.table th:last-child,.table td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
.table input{font-size:15px;text-align:center;width:100%;min-width:50px}
.table .rightAmt,.table .dailyAmt,.table .remainAmt{font-size:14px;text-align:right;padding-right:10px}
tfoot td{font-weight:800}
.small{font-size:13px;color:var(--muted)}
.log{padding:8px 12px;background:#f3f8ff;border-radius:10px;border:1px dashed #edb0f5}
.modal{position:fixed;inset:0;background:rgba(130, 94, 214, 0.35);display:none;align-items:center;justify-content:center;z-index:50}
.modal .panel{background:#fff;border-radius:16px;padding:16px;min-width:320px;max-width:420px}
.month-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
.month-btn{padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
.month-btn.active{background:#eaeaff;border-color:#1d015e;color:#9e4ae2;font-weight:700}
.modal .top{display:flex;align-items:center;justify-content:space-between}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:60}
.hidden{display:none}
.sticky-save{position:fixed;right:18px;bottom:18px;z-index:90}
.sticky-save .btn{box-shadow:0 4px 12px rgba(120, 66, 248, 0.4)}
@media (max-width:640px){ .badge{min-width:120px} }

body:not(.showLogs):not(.showHidden) #home { display: block !important; }
body:not(.showLogs):not(.showHidden) #logs { display: none !important; }
body:not(.showLogs):not(.showHidden) #hidden { display: none !important; }

body.showLogs:not(.showHidden) #home { display: none !important; }
body.showLogs:not(.showHidden) #logs { display: block !important; }
body.showLogs:not(.showHidden) #hidden { display: none !important; }

body.showHidden #home { display: none !important; }
body.showHidden #logs { display: none !important; }
body.showHidden #hidden { display: block !important; }

#logBox { display: none !important; }

body:not(.showHidden) #leftFixedTable,
body:not(.showHidden) #rightTable,
body:not(.showHidden) #kpiBlock,
body:not(.showHidden) #exportFab,
body:not(.showHidden) #exportPanel,
body:not(.showHidden) #exportPanelMask { display: none !important; }
#exportPanel:not(.show){ display:none !important; }
#exportPanelMask:not(.show), #exportMask:not(.show){ display:none !important; }
.totalLine{ display:none !important; }
.totalRow .num{float:right;font-variant-numeric:tabular-nums}

/* æµæ°´å¸³å°ˆç”¨æ¨£å¼ */
.logs-container {
  background: linear-gradient(135deg, #a6a4eb 0%, #d6d3f7 100%);
  border-radius: 16px;
  padding: 12px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.logs-table {
  width: auto;
  min-width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  background: rgba(255, 255, 255, 0.6);
  border-radius: 8px;
  overflow: visible;
  table-layout: auto;
}

.logs-table tr {
  border-bottom: 1px solid rgba(158, 109, 250, 0.2);
}

.logs-table tr:last-child {
  border-bottom: none;
}

.logs-table td {
  padding: 6px 4px;
  color: #3a069b;
  white-space: nowrap;
  vertical-align: middle;
}

/* åœ“é»æ¬„ä½ */
.logs-table td:nth-child(1) {
  padding-left: 8px;
  padding-right: 2px;
}

/* æ™‚é–“æˆ³æ¬„ä½ */
.logs-table td:nth-child(2) {
  padding-right: 2px;
}

/* åˆ†éš”ç·š */
.logs-table td:nth-child(3),
.logs-table td:nth-child(5),
.logs-table td:nth-child(7) {
  padding-left: 4px;
  padding-right: 4px;
}

/* é‡‘é¡æ¬„ä½ */
.logs-table td:nth-child(6) {
  text-align: right;
  padding-right: 2px;
}

/* å‚™è¨»æ¬„ä½ */
.logs-table td:nth-child(8) {
  padding-right: 8px;
}

/* åœ“é» */
.log-bullet {
  color: #7842f8;
  font-weight: bold;
}

/* åˆ†éš”ç·š */
.log-divider {
  color: #7842f8;
}

/* æ²’æœ‰è¨˜éŒ„æ™‚çš„æç¤º */
.logs-empty {
  color: #999;
  text-align: center;
  padding: 40px 20px;
  font-size: 15px;
}

/* åŒ¯å‡ºæŒ‰éˆ•æ¨£å¼ */
.export-btn {
  position: fixed;
  right: 18px;
  bottom: 90px;
  background: #7842f8;
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 56px;
  height: 56px;
  font-size: 24px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(120, 66, 248, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
}

.export-btn:hover {
  background: #6b27e9;
  box-shadow: 0 6px 16px rgba(120, 66, 248, 0.6);
}
</style>
</head>
<body>
  <div class="container">
    <h1>Belleçš„æ¯æ—¥è¨˜å¸³</h1>
    <div class="tabs">
      <div id="tab-home" class="tab active">é¦–é </div>
      <div id="tab-logs" class="tab">æµæ°´å¸³</div>
      <div id="tab-hidden" class="tab">å½™ç¸½è¡¨</div>
    </div>

    <div id="home">
      <div class="card">
        <div class="section-title">æœˆä»½ / å¤©æ•¸</div>
        <div class="row">
          <div class="col">
            <label class="small">æœˆä»½ï¼ˆé»ä¸€ä¸‹å¯é¸æ“‡ï¼‰</label>
            <input id="monthInput" class="input" placeholder="YYYY-MM" readonly>
          </div>
          <div class="col">
            <label class="small">å¤©æ•¸</label>
            <input id="daysInput" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="30">
          </div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">æ–°å¢ä¸€ç­†è¨˜å¸³</div>
        <div class="row">
          <div class="col">
            <label class="small">åˆ†é¡ï¼ˆå…¶ä»–é …ç›®ï¼‰</label>
            <select id="catSelect" class="input">
              <option value="">ï¼ è«‹é¸æ“‡ ï¼</option>
              <option value="ç”Ÿæ´»ç”¨å“">ç”Ÿæ´»ç”¨å“</option>
              <option value="ä¼™é£Ÿè²»">ä¼™é£Ÿè²»</option>
              <option value="å½©å¦ä¿é¤Š">å½©å¦ä¿é¤Š</option>
              <option value="ç´„æœƒåŸºé‡‘">ç´„æœƒåŸºé‡‘</option>
              <option value="å…¶ä»–æ”¯å‡º">å…¶ä»–æ”¯å‡º</option>
              <option value="ç¤¾äº¤">ç¤¾äº¤</option>
              <option value="å„²è“„">å„²è“„</option>
            </select>
          </div>
          <div class="col">
            <label class="small">é‡‘é¡</label>
            <input id="amountInput" class="input" inputmode="decimal" placeholder="è¼¸å…¥é‡‘é¡" value="0">
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label class="small">å“é … / å‚™è¨»</label>
            <input id="noteInput" class="input" placeholder="ä¾‹ï¼šè¶…å¸‚ / æ‹‰éºµ / åŒ–å¦æ°´â€¦" />
          </div>
        </div>
        <div class="row">
          <button id="addBtn" class="btn">ï¼‹ è¨˜éŒ„</button>
          <button id="restoreBtn" class="btn secondary" title="é‚„åŸä¸Šç­†">å¾©åŸä¸Šç­†</button>
        </div>
        <div id="logBox" class="log" style="margin-top:10px"></div>
      </div>
    </div>

    <div id="logs" class="hidden">
      <div class="card">
        <div class="section-title">æµæ°´å¸³</div>
        <div class="logs-container">
          <table class="logs-table" id="logsDisplay">
          </table>
          <div id="logsEmpty" class="logs-empty" style="display:none">ç›®å‰æ²’æœ‰è¨˜å¸³è¨˜éŒ„</div>
        </div>
      </div>
    </div>

    <div id="hidden" class="hidden">
      <div class="card">
        <div class="section-title">ä¸»è¦é …ç›®</div>
        <table class="table" id="leftFixedTable">
  <thead><tr><th style="width:35%">é …ç›®</th><th style="width:65%">é‡‘é¡</th></tr></thead>
  
  <tbody id="fixedOutBody">
    <tr><th colspan="2" style="text-align:left;background:#f7fbff">å›ºå®šæ”¯å‡º</th></tr>
    <tr><td>ç§Ÿé‡‘</td><td><input class="input moneyZ" value="0" data-group="fixedOut" inputmode="decimal" pattern="[0-9]*"></td></tr>
    <tr><td>ä¿éšªè²»ï¼ˆM&Momï¼‰</td><td><input class="input moneyZ" value="0" data-group="fixedOut" inputmode="decimal" pattern="[0-9]*"></td></tr>
    <tr><td>é›»ä¿¡è²»</td><td><input class="input moneyZ" value="0" data-group="fixedOut" inputmode="decimal" pattern="[0-9]*"></td></tr>
    <tr><td>é›»ï¼ˆ1åº¦5å…ƒï¼‰</td><td><input class="input moneyZ" value="0" data-group="fixedOut" inputmode="decimal" pattern="[0-9]*"></td></tr>
    <tr><td>ä¿¡ç”¨å¡</td><td><input class="input moneyZ" value="0" data-group="fixedOut" inputmode="decimal" pattern="[0-9]*"></td></tr>
    <tr id="fixedOutCustomAnchor">
      <td colspan="2" style="padding:0;border:none">
        <table style="width:100%;border-collapse:separate;border-spacing:0 10px">
          <tbody id="fixedOutCustomRows"></tbody>
        </table>
      </td>
    </tr>
    <tr>
      <td colspan="2" style="background:#f9fbff;border:1px dashed #cfe0ff;border-radius:10px;padding:10px">
        <button id="fixedOutAdd" class="btn secondary" type="button"
                style="padding:6px 10px;border-radius:8px;font-size:13px">ï¼‹ æ–°å¢æ¬„ä½</button>
        <span class="small" style="margin-left:8px">å¯è‡ªè¨‚åç¨±èˆ‡é‡‘é¡</span>
      </td>
    </tr>
    <tr class="totalRow"><td colspan="2"><b>å›ºå®šæ”¯å‡º Total</b><span style="float:right" id="fixedOutTotal">0</span></td></tr>
  </tbody>
  
  <tbody id="fixedInBody">
    <tr><th colspan="2" style="text-align:left;background:#f7fbff">å›ºå®šæ”¶å…¥</th></tr>
    <tr><td>JET è–ªè³‡</td><td><input class="input moneyZ" value="0" data-group="fixedIn" inputmode="decimal" pattern="[0-9]*"></td></tr>
    <tr><td>JET çé‡‘</td><td><input class="input moneyZ" value="0" data-group="fixedIn" inputmode="decimal" pattern="[0-9]*"></td></tr>
    <tr><td>SK è–ªè³‡</td><td><input class="input moneyZ" value="0" data-group="fixedIn" inputmode="decimal" pattern="[0-9]*"></td></tr>
    <tr id="fixedInCustomAnchor">
      <td colspan="2" style="padding:0;border:none">
        <table style="width:100%;border-collapse:separate;border-spacing:0 10px">
          <tbody id="fixedInCustomRows"></tbody>
        </table>
      </td>
    </tr>
    <tr>
      <td colspan="2" style="background:#f9fbff;border:1px dashed #cfe0ff;border-radius:10px;padding:10px">
        <button id="fixedInAdd" class="btn secondary" type="button"
                style="padding:6px 10px;border-radius:8px;font-size:13px">ï¼‹ æ–°å¢æ¬„ä½</button>
        <span class="small" style="margin-left:8px">å¯è‡ªè¨‚åç¨±èˆ‡é‡‘é¡</span>
      </td>
    </tr>
    <tr class="totalRow"><td colspan="2"><b>å›ºå®šæ”¶å…¥ Total</b><span style="float:right" id="fixedInTotal">0</span></td></tr>
  </tbody>
  
  <tbody id="savingBody">
    <tr><th colspan="2" style="text-align:left;background:#f7fbff">å„²è“„</th></tr>
    <tr><td>å­˜å°éŠ€ï¼ˆå­¸è²»ï¼‰</td><td><input class="input moneyZ" value="0" data-group="saving" inputmode="decimal" pattern="[0-9]*"></td></tr>
    <tr><td>ç¾é‡‘æ›åŒ¯</td><td><input class="input moneyZ" value="0" data-group="saving" inputmode="decimal" pattern="[0-9]*"></td></tr>
    <tr><td>å­˜ç‰å±±</td><td><input class="input moneyZ" value="0" data-group="saving" inputmode="decimal" pattern="[0-9]*"></td></tr>
    <tr><td>æ—…éŠåŸºé‡‘</td><td><input class="input moneyZ" value="0" data-group="saving" inputmode="decimal" pattern="[0-9]*"></td></tr>
    <tr id="savingCustomAnchor">
      <td colspan="2" style="padding:0;border:none">
        <table style="width:100%;border-collapse:separate;border-spacing:0 10px">
          <tbody id="savingCustomRows"></tbody>
        </table>
      </td>
    </tr>
    <tr>
      <td colspan="2" style="background:#f9fbff;border:1px dashed #cfe0ff;border-radius:10px;padding:10px">
        <button id="savingAdd" class="btn secondary" type="button"
                style="padding:6px 10px;border-radius:8px;font-size:13px">ï¼‹ æ–°å¢æ¬„ä½</button>
        <span class="small" style="margin-left:8px">å¯è‡ªè¨‚åç¨±èˆ‡é‡‘é¡</span>
      </td>
    </tr>
    <tr class="totalRow"><td colspan="2"><b>å„²è“„ Total</b><span style="float:right" id="savingTotal">0</span></td></tr>
  </tbody>
  
  <tbody id="extraInBody">
    <tr><th colspan="2" style="text-align:left;background:#f7fbff">é¡å¤–æ”¶å…¥</th></tr>
    <tr><td>ç™¼ç¥¨ä¸­ç</td><td><input class="input moneyZ" value="0" data-group="extraIn" inputmode="decimal" pattern="[0-9]*"></td></tr>
    <tr id="extraInCustomAnchor">
      <td colspan="2" style="padding:0;border:none">
        <table style="width:100%;border-collapse:separate;border-spacing:0 10px">
          <tbody id="extraInCustomRows"></tbody>
        </table>
      </td>
    </tr>
    <tr>
      <td colspan="2" style="background:#f9fbff;border:1px dashed #cfe0ff;border-radius:10px;padding:10px">
        <button id="extraInAdd" class="btn secondary" type="button"
                style="padding:6px 10px;border-radius:8px;font-size:13px">ï¼‹ æ–°å¢æ¬„ä½</button>
        <span class="small" style="margin-left:8px">å¯è‡ªè¨‚åç¨±èˆ‡é‡‘é¡</span>
      </td>
    </tr>
    <tr class="totalRow"><td colspan="2"><b>é¡å¤–æ”¶å…¥ Total</b><span style="float:right" id="extraInTotal">0</span></td></tr>
  </tbody>
  
  <tbody id="extraOutBody">
    <tr><th colspan="2" style="text-align:left;background:#f7fbff">é¡å¤–æ”¯å‡º</th></tr>
    <tr><td>æ¬å®¶è²»ç”¨</td><td><input class="input moneyZ" value="0" data-group="extraOut" inputmode="decimal" pattern="[0-9]*"></td></tr>
    <tr id="extraOutCustomAnchor">
      <td colspan="2" style="padding:0;border:none">
        <table style="width:100%;border-collapse:separate;border-spacing:0 10px">
          <tbody id="extraOutCustomRows"></tbody>
        </table>
      </td>
    </tr>
    <tr>
      <td colspan="2" style="background:#f9fbff;border:1px dashed #cfe0ff;border-radius:10px;padding:10px">
        <button id="extraOutAdd" class="btn secondary" type="button"
                style="padding:6px 10px;border-radius:8px;font-size:13px">ï¼‹ æ–°å¢æ¬„ä½</button>
        <span class="small" style="margin-left:8px">å¯è‡ªè¨‚åç¨±èˆ‡é‡‘é¡</span>
      </td>
    </tr>
    <tr class="totalRow">
      <td colspan="2"><b>é¡å¤–æ”¯å‡º Total</b> <span class="num" id="extraOutTotal">0</span></td>
    </tr>
  </tbody>
</table>

<script>
(function(){
  function esc(s){return (s==null?'':String(s)).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
  function num2(v){try{return (typeof num==='function')?num(v):parseFloat((v||'').replace(/[^0-9.+-]/g,''))||0;}catch(e){return 0;}}
  function key(){try{return 'book-'+(keyForMonth?keyForMonth():document.getElementById('monthInput')?.value||new Date().toISOString().slice(0,7));}catch(e){return 'book-'+new Date().toISOString().slice(0,7);}}
  function r(){try{const s=localStorage.getItem(key());return s?JSON.parse(s):{};}catch(_){return {};}}
  function w(o){try{localStorage.setItem(key(),JSON.stringify(o||{}));}catch(_){}}

  function addCustomRow(group, name='', amount=0){
    const rowsId = group + 'CustomRows';
    const rows = document.getElementById(rowsId);
    if(!rows) return;
    
    const tr = document.createElement('tr');
    tr.className = group + 'Custom';
    tr.innerHTML =
      '<td style="width:40%"><input class="input customName" data-group="'+group+'" placeholder="è‡ªè¨‚åç¨±" value="'+esc(name)+'" inputmode="text"></td>'+
      '<td><div style="display:flex;gap:8px;align-items:center">'+
        '<input class="input moneyZ" value="'+(amount||0)+'" data-group="'+group+'" inputmode="decimal" pattern="[0-9]*">'+
        '<button type="button" class="btn secondary" style="padding:6px 10px;border-radius:8px;font-size:13px">ï¼</button>'+
      '</div></td>';
    rows.appendChild(tr);
    
    tr.querySelector('button').addEventListener('click',()=>{
      tr.remove(); 
      try{computeTotals&&computeTotals();}catch(e){}
      saveNow();
    });
    
    const inp=tr.querySelector('input.moneyZ');
    if(inp){
      inp.addEventListener('focus',()=>{ if(inp.value==='0') inp.value=''; });
      inp.addEventListener('blur', ()=>{ if(inp.value==='')  inp.value='0'; });
    }
    
    tr.addEventListener('input',e=>{
      if(e.target && (e.target.classList.contains('moneyZ')||e.target.classList.contains('customName'))) saveNow();
    },true);
  }

  function collectCustom(group){
    const rowsId = group + 'CustomRows';
    const rows = document.querySelectorAll('#'+rowsId+' tr.'+group+'Custom');
    return Array.from(rows).map(tr=>{
      const name=tr.querySelector('.customName')?.value||'';
      const v   =tr.querySelector('.moneyZ')?.value||'0';
      const n=num2(v);
      return (name.trim()!==''||n>0)?{name,amount:n}:null;
    }).filter(Boolean);
  }

  function renderCustom(group, list){
    const rowsId = group + 'CustomRows';
    const cont = document.getElementById(rowsId);
    if(!cont) return;
    cont.innerHTML='';
    (list||[]).forEach(it=>addCustomRow(group, it.name||'', it.amount||0));
  }

  function saveNow(){
    const obj=r();
    ['fixedOut', 'fixedIn', 'saving', 'extraIn', 'extraOut'].forEach(group=>{
      obj[group+'Custom'] = collectCustom(group);
    });
    w(obj);
  }

  ['fixedOut', 'fixedIn', 'saving', 'extraIn', 'extraOut'].forEach(group=>{
    const btn = document.getElementById(group+'Add');
    if(btn){
      btn.addEventListener('click',()=>{ 
        addCustomRow(group); 
        try{computeTotals&&computeTotals();}catch(e){}
        saveNow(); 
      });
    }
  });

  document.addEventListener('input',e=>{
    const t=e.target;
    if(t?.matches && (t.matches('input.moneyZ')||t.matches('.customName'))) saveNow();
  },true);
  
  document.addEventListener('change',e=>{
    const t=e.target;
    if(t?.matches && (t.matches('input.moneyZ')||t.matches('.customName'))) saveNow();
  },true);

  window.addEventListener('pagehide',saveNow,{capture:true});
  document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='hidden') saveNow(); },{capture:true});
  window.addEventListener('beforeunload',saveNow,{capture:true});

  if (typeof lsSet==='function'){
    const _lsSet=lsSet;
    window.lsSet=function(k,v){
      try{ 
        if(typeof k==='string'&&k.indexOf('book-')===0&&v&&typeof v==='object'){ 
          ['fixedOut', 'fixedIn', 'saving', 'extraIn', 'extraOut'].forEach(group=>{
            v[group+'Custom'] = collectCustom(group);
          });
        } 
      }catch(_){}
      try{ return _lsSet.apply(this,arguments); }catch(_){}
    };
  }

  (function(){
    const _set = Storage.prototype.setItem;
    Storage.prototype.setItem=function(k,v){
      try{
        if(typeof k==='string'&&k.indexOf('book-')===0){
          let base={}; 
          try{ base=JSON.parse(v);}catch(_){base={};}
          ['fixedOut', 'fixedIn', 'saving', 'extraIn', 'extraOut'].forEach(group=>{
            base[group+'Custom'] = collectCustom(group);
          });
          arguments[1]=JSON.stringify(base);
        }
      }catch(_){}
      return _set.apply(this,arguments);
    };
  })();

  function restore(){
    const d=r();
    ['fixedOut', 'fixedIn', 'saving', 'extraIn', 'extraOut'].forEach(group=>{
      renderCustom(group, d[group+'Custom']||[]);
    });
    try{computeTotals&&computeTotals();}catch(e){}
  }
  
  if(document.readyState==='loading'){ 
    document.addEventListener('DOMContentLoaded',()=>{
      restore();
      setTimeout(restore,50);
      setTimeout(restore,300);
    }); 
  } else { 
    restore(); 
    setTimeout(restore,50); 
    setTimeout(restore,300); 
  }
  
  document.getElementById('tab-hidden')?.addEventListener('click',()=>setTimeout(restore,0));
})();
</script>
      </table>
      </div>

      <div class="card" style="overflow:visible;padding:0">
        <div class="section-title" style="padding:16px 16px 0 16px">å…¶ä»–é …ç›®</div>
      <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;margin:0;padding:16px 20px 16px 16px">
        <table class="table" id="rightTable" style="min-width:750px;width:750px">
          <thead>
            <tr>
              <th style="width:90px">é …ç›®</th>
              <th style="width:90px">%</th>
              <th style="width:120px">æ”¤æé‡‘é¡</th>
              <th style="width:120px">æ¯æ—¥é ç®—</th>
              <th style="width:110px">å·²ä½¿ç”¨</th>
              <th style="width:120px">çµé¤˜</th>
            </tr>
          </thead>
          <tbody id="rightBody">
          </tbody>
          <tfoot>
            <tr>
              <td class="small">åˆè¨ˆ</td>
              <td id="sumPct">100.0%</td>
              <td id="sumRight">0</td>
              <td id="sumDaily">0</td>
              <td id="sumUsed">0</td>
              <td id="sumRemain">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
      </div>

      <div class="card" id="kpiBlock">
        <div class="section-title">åˆè¨ˆ</div>
        <div class="row">
          <div class="badge"><div class="label">æœˆçµé¤˜</div><div id="kpi_balance" class="num">0</div></div>
          <div class="badge"><div class="label">æ”¤æç¸½å’Œ</div><div id="kpi_right" class="num">0</div></div>
          <div class="badge"><div class="label">å·²ä½¿ç”¨ç¸½å’Œ</div><div id="kpi_used" class="num">0</div></div>
          <div class="badge"><div class="label">çµé¤˜ç¸½å’Œ</div><div id="kpi_remain" class="num">0</div></div>
        </div>
        <div class="row">
          <div class="badge"><div class="label">ç¸½æ”¶å…¥</div><div id="kpi_income" class="num">0</div></div>
          <div class="badge"><div class="label">ç¸½å›ºå®šæ”¯å‡º</div><div id="kpi_fixedout" class="num">0</div></div>
          <div class="badge"><div class="label">ç¸½å„²è“„</div><div id="kpi_saving" class="num">0</div></div>
          <div class="badge"><div class="label">å¯æ”¯é…é‡‘</div><div id="kpi_free" class="num">0</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ‰‹å‹•å„²å­˜æŒ‰éˆ•ï¼ˆå…¨å±€é¡¯ç¤ºï¼‰ -->
  <div class="sticky-save">
    <button id="saveBtn" class="btn">ğŸ’¾ å„²å­˜</button>
  </div>

  <!-- æ‰‹å‹•åŒ¯å‡ºæŒ‰éˆ• -->
  <button id="exportBtn" class="export-btn" title="åŒ¯å‡ºç•¶æœˆè³‡æ–™">ğŸ“¥</button>

  <div id="monthModal" class="modal">
    <div class="panel">
      <div class="top">
        <button id="prevYear" class="btn secondary">Â«</button>
        <div id="yearTitle" style="font-weight:800">2025 å¹´</div>
        <button id="nextYear" class="btn secondary">Â»</button>
      </div>
      <div class="month-grid" id="monthGrid"></div>
      <div class="inline" style="justify-content:flex-end;margin-top:10px">
        <button id="cancelMonth" class="btn secondary">å–æ¶ˆ</button>
        <button id="okMonth" class="btn">ç¢ºå®š</button>
      </div>
    </div>
  </div>
  <div id="toast" class="toast"></div>

<script>
const CATS = ["ç”Ÿæ´»ç”¨å“","ä¼™é£Ÿè²»","å½©å¦ä¿é¤Š","ç´„æœƒåŸºé‡‘","å…¶ä»–æ”¯å‡º","ç¤¾äº¤","å„²è“„"];

function renderRightRows(){
  const tb = document.getElementById('rightBody');
  tb.innerHTML = '';
  CATS.forEach(cat=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${cat}</td>
      <td><input class="input pct" value="0" data-cat="${cat}" inputmode="decimal" pattern="[0-9]*"></td>
      <td class="rightAmt" data-cat="${cat}">0</td>
      <td class="dailyAmt" data-cat="${cat}">0</td>
      <td><input class="input used" value="0" data-cat="${cat}" inputmode="decimal" pattern="[0-9]*"></td>
      <td class="remainAmt" data-cat="${cat}">0</td>
    `;
    tb.appendChild(tr);
  });
}
renderRightRows();

function fmt(n){ return Number(n||0).toLocaleString('zh-TW'); }
function num(v){ const n = parseFloat(v); return isNaN(n)?0:n; }
function toast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display='block';
  setTimeout(()=>t.style.display='none',1500);
}
function keyForMonth(){ return (document.getElementById('monthInput').value || new Date().toISOString().slice(0,7)); }
function lsGet(k,def){ 
  try{ 
    const val = localStorage.getItem(k);
    if (!val) return def;
    return JSON.parse(val) ?? def;
  } catch(e){ 
    console.error('è®€å–è³‡æ–™å¤±æ•—:', e);
    return def;
  } 
}

function lsSet(k,v){ 
  try {
    localStorage.setItem(k, JSON.stringify(v));
    // é©—è­‰å¯«å…¥
    const verify = localStorage.getItem(k);
    if (!verify) {
      console.error('è³‡æ–™å¯«å…¥å¤±æ•—');
      alert('âš ï¸ è³‡æ–™å„²å­˜å¤±æ•—ï¼è«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šã€‚');
    }
  } catch(e) {
    console.error('å„²å­˜è³‡æ–™å¤±æ•—:', e);
    alert('âš ï¸ å„²å­˜å¤±æ•—ï¼š' + e.message);
  }
}

const monthInput = document.getElementById('monthInput');
const daysInput  = document.getElementById('daysInput');
(function initMonth(){
  const now = new Date();
  const ym = now.toISOString().slice(0,7);
  monthInput.value = ym;
  daysInput.value = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
})();

const modal = document.getElementById('monthModal');
let pickYear = new Date().getFullYear();
let pickMonth = new Date().getMonth()+1;
function openMonthModal(){
  pickYear = (monthInput.value? Number(monthInput.value.slice(0,4)) : new Date().getFullYear());
  pickMonth = (monthInput.value? Number(monthInput.value.slice(5,7)) : (new Date().getMonth()+1));
  document.getElementById('yearTitle').textContent = pickYear+' å¹´';
  const grid = document.getElementById('monthGrid');
  grid.innerHTML = '';
  for(let m=1;m<=12;m++){
    const btn = document.createElement('button');
    btn.className='month-btn'+(m===pickMonth?' active':'');
    btn.textContent = m+'æœˆ';
    btn.onclick = ()=>{
      pickMonth = m;
      [...grid.children].forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    };
    grid.appendChild(btn);
  }
  modal.style.display='flex';
}

monthInput.addEventListener('click', function(e){
  e.preventDefault();
  openMonthModal();
}, true);

monthInput.addEventListener('touchstart', function(e){
  e.preventDefault();
  openMonthModal();
}, {passive: false});

monthInput.addEventListener('focus', function(e){
  e.preventDefault();
  this.blur();
  openMonthModal();
});

document.getElementById('prevYear').onclick=()=>{ pickYear--; document.getElementById('yearTitle').textContent = pickYear+' å¹´'; };
document.getElementById('nextYear').onclick=()=>{ pickYear++; document.getElementById('yearTitle').textContent = pickYear+' å¹´'; };
document.getElementById('cancelMonth').onclick=()=> modal.style.display='none';
document.getElementById('okMonth').onclick=()=>{
  const oldMonth = monthInput.value;
  const ym = pickYear+'-'+String(pickMonth).padStart(2,'0');
  monthInput.value = ym;
  const days = new Date(pickYear, pickMonth, 0).getDate();
  daysInput.value = days;
  modal.style.display='none';
  if(oldMonth !== ym){
    loadMonth(true);
  }
};

function attachZeroClear(selector){
  document.querySelectorAll(selector).forEach(inp=>{
    inp.addEventListener('focus',()=>{ if(inp.value==='0') inp.value=''; });
    inp.addEventListener('blur', ()=>{ if(inp.value==='') inp.value='0'; });
  });
}
function refreshZeroClear(){
  attachZeroClear('input.moneyZ');
  attachZeroClear('input.pct');
  attachZeroClear('input.used');
  attachZeroClear('#amountInput');
}
refreshZeroClear();

function computeTotals(){
  let fixedOut=0,fixedIn=0,saving=0,extraIn=0,extraOut=0;
  document.querySelectorAll('input.moneyZ[data-group="fixedOut"]').forEach(i=>fixedOut += num(i.value));
  document.querySelectorAll('input.moneyZ[data-group="fixedIn"]').forEach(i=>fixedIn += num(i.value));
  document.querySelectorAll('input.moneyZ[data-group="saving"]').forEach(i=>saving += num(i.value));
  document.querySelectorAll('input.moneyZ[data-group="extraIn"]').forEach(i=>extraIn += num(i.value));
  document.querySelectorAll('input.moneyZ[data-group="extraOut"]').forEach(i=>extraOut += num(i.value));
  
  document.getElementById('fixedOutTotal').textContent = fmt(fixedOut.toFixed(0));
  document.getElementById('fixedInTotal').textContent = fmt(fixedIn.toFixed(0));
  document.getElementById('savingTotal').textContent = fmt(saving.toFixed(0));
  document.getElementById('extraInTotal').textContent = fmt(extraIn.toFixed(0));
  document.getElementById('extraOutTotal').textContent = fmt(extraOut.toFixed(0));
  
  // ç¸½æ”¶å…¥ = å›ºå®šæ”¶å…¥(Total) + é¡å¤–æ”¶å…¥(Total)
  const totalIncome = fixedIn + extraIn;
  
  // å¯æ”¯é…é‡‘ = å›ºå®šæ”¶å…¥(Total) + é¡å¤–æ”¶å…¥(Total) - å„²è“„(Total) - å›ºå®šæ”¯å‡º(Total)
  const free = totalIncome - fixedOut - saving;

  let sumPct=0,sumRight=0,sumDaily=0,sumUsed=0,sumRemain=0;
  const days = Math.max(1, num(daysInput.value));
  document.querySelectorAll('#rightBody tr').forEach(tr=>{
    const cat = tr.querySelector('.pct').dataset.cat;
    const pct = num(tr.querySelector('.pct').value);
    const used = num(tr.querySelector('.used').value);
    sumPct += pct;
    
    // æ”¤æé‡‘é¡ = å›ºå®šæ”¶å…¥(Total) * %ï¼ˆæ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ fixedIn è€Œé freeï¼‰
    const right = Math.max(0, fixedIn * pct / 100);
    
    // æ¯æ—¥é ç®— = æ”¤æé‡‘é¡ Ã· å¤©æ•¸
    const daily = right / days;
    
    // çµé¤˜ = æ”¤æé‡‘é¡ - å·²ä½¿ç”¨
    const remain = right - used;
    
    tr.querySelector('.rightAmt').textContent = fmt(right.toFixed(0));
    tr.querySelector('.dailyAmt').textContent = fmt(daily.toFixed(2));
    tr.querySelector('.remainAmt').textContent = fmt(remain.toFixed(0));
    
    // æ”¤æç¸½å’Œï¼ˆåˆè¨ˆï¼‰
    sumRight += right; 
    sumDaily += daily; 
    sumUsed += used; 
    sumRemain += remain;
  });

  document.getElementById('sumPct').textContent = (sumPct.toFixed(1))+'%';
  document.getElementById('sumRight').textContent = fmt(sumRight.toFixed(0));
  document.getElementById('sumDaily').textContent = fmt(sumDaily.toFixed(2));
  document.getElementById('sumUsed').textContent = fmt(sumUsed.toFixed(0));
  document.getElementById('sumRemain').textContent = fmt(sumRemain.toFixed(0));

  // ç¸½æ”¶å…¥ = å›ºå®šæ”¶å…¥(Total) + é¡å¤–æ”¶å…¥(Total)
  document.getElementById('kpi_income').textContent = fmt(totalIncome.toFixed(0));
  
  // ç¸½å›ºå®šæ”¯å‡º = å„²è“„(Total) + å›ºå®šæ”¯å‡º(Total)
  const totalFixedOut = saving + fixedOut;
  document.getElementById('kpi_fixedout').textContent = fmt(totalFixedOut.toFixed(0));
  
  // ç¸½å„²è“„ = å„²è“„(Total)
  document.getElementById('kpi_saving').textContent = fmt(saving.toFixed(0));
  
  // å¯æ”¯é…é‡‘ = å›ºå®šæ”¶å…¥(Total) + é¡å¤–æ”¶å…¥(Total) - å„²è“„(Total) - å›ºå®šæ”¯å‡º(Total)
  document.getElementById('kpi_free').textContent = fmt(free.toFixed(0));
  
  // æ”¤æç¸½å’Œï¼ˆåˆè¨ˆï¼‰= å„é …æ”¤æé‡‘é¡çš„ç¸½å’Œ
  document.getElementById('kpi_right').textContent = fmt(sumRight.toFixed(0));
  
  // å·²ä½¿ç”¨ç¸½å’Œ = å„é …å·²ä½¿ç”¨é‡‘é¡çš„ç¸½å’Œ
  document.getElementById('kpi_used').textContent = fmt(sumUsed.toFixed(0));
  
  // çµé¤˜ç¸½å’Œ = å„é …çµé¤˜é‡‘é¡çš„ç¸½å’Œ
  document.getElementById('kpi_remain').textContent = fmt(sumRemain.toFixed(0));
  
  // æœˆçµé¤˜ = å›ºå®šæ”¶å…¥(Total) + é¡å¤–æ”¶å…¥(Total) - å„²è“„(Total) - å›ºå®šæ”¯å‡º(Total) - é¡å¤–æ”¯å‡º(Total)
  const monthBalance = fixedIn + extraIn - saving - fixedOut - extraOut;
  document.getElementById('kpi_balance').textContent = fmt(monthBalance.toFixed(0));
}

document.addEventListener('input', e=>{
  if(e.target.matches('.pct,.used,.moneyZ,#daysInput')) computeTotals();
});

// è§£ææµæ°´å¸³ä¸¦ç¾åŒ–é¡¯ç¤º
function updateLogsDisplay(){
  const logsTable = document.getElementById('logsDisplay');
  const logsEmpty = document.getElementById('logsEmpty');
  const key = 'book-'+keyForMonth();
  const d = lsGet(key, null);
  
  if(!d || !d.log || d.log.trim() === ''){
    logsTable.style.display = 'none';
    logsEmpty.style.display = 'block';
    return;
  }
  
  logsTable.style.display = 'table';
  logsEmpty.style.display = 'none';
  
  // ç²å–ç•¶å‰é¸æ“‡çš„å¹´æœˆ
  const selectedYM = keyForMonth(); // ä¾‹å¦‚ï¼š2025-11
  const [selectedYear, selectedMonth] = selectedYM.split('-').map(Number);
  
  // è§£æ HTML å…§å®¹
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = d.log;
  const logItems = tempDiv.querySelectorAll('div');
  
  let html = '';
  logItems.forEach(item => {
    const text = item.textContent || '';
    // æ ¼å¼: â€¢ 2025/10/23 01:54 ï½œ ç”Ÿæ´»ç”¨å“ ï½œ 888 ï½œ æ´—é¢ä¹³ï¼ˆ3å¤§5å°ï¼‰
    const match = text.match(/^â€¢\s*(.+?)\s*ï½œ\s*(.+?)\s*ï½œ\s*(.+?)(?:\s*ï½œ\s*(.+))?$/);
    
    if(match){
      const [, datetime, category, amount, note] = match;
      
      // è§£ææ™‚é–“æˆ³è¨˜çš„å¹´æœˆï¼ˆæ ¼å¼ï¼š2025/10/23 æˆ– 2025/10/23 17:54ï¼‰
      const dateMatch = datetime.trim().match(/^(\d{4})\/(\d{1,2})/);
      if(dateMatch){
        const recordYear = parseInt(dateMatch[1]);
        const recordMonth = parseInt(dateMatch[2]);
        
        // åªé¡¯ç¤ºèˆ‡ç•¶å‰é¸æ“‡æœˆä»½ç›¸ç¬¦çš„è¨˜éŒ„
        if(recordYear === selectedYear && recordMonth === selectedMonth){
          html += '<tr>';
          html += '<td class="log-bullet">â€¢</td>';
          html += '<td>' + datetime.trim() + '</td>';
          html += '<td class="log-divider">ï½œ</td>';
          html += '<td>' + category.trim() + '</td>';
          html += '<td class="log-divider">ï½œ</td>';
          html += '<td>' + amount.trim() + '</td>';
          if(note && note.trim()){
            html += '<td class="log-divider">ï½œ</td>';
            html += '<td>' + note.trim() + '</td>';
          } else {
            html += '<td></td><td></td>';
          }
          html += '</tr>';
        }
      }
    }
  });
  
  // å¦‚æœéæ¿¾å¾Œæ²’æœ‰è¨˜éŒ„ï¼Œé¡¯ç¤ºç©ºç™½è¨Šæ¯
  if(html === ''){
    logsTable.style.display = 'none';
    logsEmpty.style.display = 'block';
  } else {
    logsTable.innerHTML = html;
  }
}

const logBox = document.getElementById('logBox');
let lastRecord = null;
document.getElementById('addBtn').onclick = ()=>{
  const cat = document.getElementById('catSelect').value;
  const amt = num(document.getElementById('amountInput').value);
  const note = document.getElementById('noteInput').value.trim();
  if(!cat){ toast('è«‹å…ˆé¸æ“‡åˆ†é¡'); return; }
  if(!(amt>0)){ toast('é‡‘é¡éœ€ç‚ºæ­£æ•¸'); return; }
  
  // è¨˜éŒ„åˆ°ç•¶å‰ç³»çµ±æ™‚é–“çš„æœˆä»½ï¼Œè€Œéé¸æ“‡å™¨çš„æœˆä»½
  const t = new Date();
  const currentYM = t.toISOString().slice(0,7);
  const currentKey = 'book-' + currentYM;
  
  const stamp = t.getFullYear()+'/'+String(t.getMonth()+1).padStart(2,'0')+'/'+String(t.getDate()).padStart(2,'0')+' '+String(t.getHours()).padStart(2,'0')+':'+String(t.getMinutes()).padStart(2,'0');
  const line = `${stamp} ï½œ ${cat} ï½œ ${fmt(amt)}${note?(' ï½œ '+note):''}`;
  
  // ç²å–ç•¶æœˆè³‡æ–™
  const currentData = lsGet(currentKey, null) || {
    days: new Date(t.getFullYear(), t.getMonth()+1, 0).getDate(),
    fixedOut: [],
    fixedIn: [],
    saving: [],
    extraIn: [],
    extraOut: [],
    pct: CATS.map(()=>0),
    used: CATS.map(()=>0),
    log: ''
  };
  
  // æ›´æ–°ç•¶æœˆçš„å·²ä½¿ç”¨é‡‘é¡
  const catIndex = CATS.indexOf(cat);
  if(catIndex >= 0){
    currentData.used[catIndex] = (currentData.used[catIndex] || 0) + amt;
  }
  
  // æ›´æ–°ç•¶æœˆçš„æµæ°´å¸³
  currentData.log = `<div>â€¢ ${line}</div>` + (currentData.log || '');
  
  lsSet(currentKey, currentData);
  
  // é©—è­‰è³‡æ–™æ˜¯å¦ä¿å­˜æˆåŠŸ
  const verified = lsGet(currentKey, null);
  if (!verified || !verified.log || !verified.log.includes(line)) {
    console.error('è³‡æ–™é©—è­‰å¤±æ•—');
    alert('âš ï¸ è³‡æ–™å¯èƒ½æ²’æœ‰æ­£ç¢ºä¿å­˜ï¼è«‹é‡æ–°è¨˜å¸³ã€‚');
    return;
  }
  
  lastRecord = {cat, amt, note, month: currentYM};
  
  toast('å·²è¨˜éŒ„åˆ° ' + currentYM);
  
  // å¦‚æœç•¶å‰é¸æ“‡çš„æœˆä»½æ˜¯æœ¬æœˆï¼Œå‰‡æ›´æ–°é¡¯ç¤º
  if(monthInput.value === currentYM){
    const usedInput = document.querySelector(`.used[data-cat="${cat}"]`);
    if(usedInput){
      usedInput.value = currentData.used[catIndex];
    }
    logBox.innerHTML = `<div>â€¢ ${line}</div>` + logBox.innerHTML;
    computeTotals();
    updateLogsDisplay();
  }
  
  document.getElementById('amountInput').value='0';
  document.getElementById('noteInput').value='';
};

document.getElementById('restoreBtn').onclick=()=>{
  if(!lastRecord){ toast('æ²’æœ‰å¯å¾©åŸçš„ç´€éŒ„'); return; }
  
  // å¾è¨˜éŒ„çš„æœˆä»½å¾©åŸ
  const recordKey = 'book-' + lastRecord.month;
  const recordData = lsGet(recordKey, null);
  
  if(!recordData){ 
    toast('æ‰¾ä¸åˆ°è¨˜éŒ„'); 
    lastRecord = null;
    return; 
  }
  
  // æ›´æ–°å·²ä½¿ç”¨é‡‘é¡
  const catIndex = CATS.indexOf(lastRecord.cat);
  if(catIndex >= 0 && recordData.used && recordData.used[catIndex]){
    recordData.used[catIndex] = Math.max(0, recordData.used[catIndex] - lastRecord.amt);
  }
  
  // ç§»é™¤æµæ°´å¸³çš„ç¬¬ä¸€ç­†è¨˜éŒ„
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = recordData.log || '';
  const firstDiv = tempDiv.querySelector('div');
  if(firstDiv) firstDiv.remove();
  recordData.log = tempDiv.innerHTML;
  
  lsSet(recordKey, recordData);
  
  // å¦‚æœç•¶å‰é¸æ“‡çš„æœˆä»½æ˜¯è¨˜éŒ„çš„æœˆä»½ï¼Œå‰‡æ›´æ–°é¡¯ç¤º
  if(monthInput.value === lastRecord.month){
    const usedInput = document.querySelector(`.used[data-cat="${lastRecord.cat}"]`);
    if(usedInput){
      usedInput.value = recordData.used[catIndex];
    }
    
    const firstDivInBox = logBox.querySelector('div');
    if(firstDivInBox) firstDivInBox.remove();
    
    computeTotals();
    updateLogsDisplay();
  }
  
  toast('å·²å¾©åŸä¸Šç­†');
  lastRecord = null;
};

function resetAllFields(){
  const ym = keyForMonth();
  const [y, m] = ym.split('-').map(Number);
  const days = new Date(y, m, 0).getDate();
  daysInput.value = days;
  
  document.querySelectorAll('input.moneyZ').forEach(i => i.value = '0');
  
  CATS.forEach(c => {
    const pctInput = document.querySelector(`.pct[data-cat="${c}"]`);
    const usedInput = document.querySelector(`.used[data-cat="${c}"]`);
    if(pctInput) pctInput.value = '0';
    if(usedInput) usedInput.value = '0';
  });
  
  logBox.innerHTML = '';
  
  ['fixedOut', 'fixedIn', 'saving', 'extraIn', 'extraOut'].forEach(group=>{
    const customRows = document.getElementById(group+'CustomRows');
    if(customRows) customRows.innerHTML = '';
  });
  
  computeTotals();
  refreshZeroClear();
  updateLogsDisplay();
}

function saveMonth(){
  const key = 'book-'+keyForMonth();
  const data = {
    days: num(daysInput.value),
    fixedOut: [...document.querySelectorAll('input.moneyZ[data-group="fixedOut"]')].map(i=>num(i.value)),
    fixedIn:  [...document.querySelectorAll('input.moneyZ[data-group="fixedIn"]')].map(i=>num(i.value)),
    saving:   [...document.querySelectorAll('input.moneyZ[data-group="saving"]')].map(i=>num(i.value)),
    extraIn:  [...document.querySelectorAll('input.moneyZ[data-group="extraIn"]')].map(i=>num(i.value)),
    extraOut: [...document.querySelectorAll('input.moneyZ[data-group="extraOut"]')].map(i=>num(i.value)),
    pct:  CATS.map(c=>num(document.querySelector(`.pct[data-cat="${c}"]`).value)),
    used: CATS.map(c=>num(document.querySelector(`.used[data-cat="${c}"]`).value)),
    log:  logBox.innerHTML
  };
  lsSet(key, data);
  toast('å·²å„²å­˜');
}

function loadMonth(shouldResetIfEmpty){
  const key = 'book-'+keyForMonth();
  const d = lsGet(key, null);
  
  if(!d){ 
    if(shouldResetIfEmpty){
      resetAllFields();
    } else {
      computeTotals();
      updateLogsDisplay();
    }
    return; 
  }
  
  daysInput.value = d.days ?? daysInput.value;
  
  ['fixedOut','fixedIn','saving','extraIn','extraOut'].forEach(group=>{
    const values = d[group]||[];
    document.querySelectorAll(`input.moneyZ[data-group="${group}"]`).forEach((i,idx)=> {
      i.value = (values[idx] !== undefined && values[idx] !== null) ? values[idx] : '0';
    });
  });
  
  CATS.forEach((c,idx)=>{
    const p = (d.pct||[])[idx] ?? 0;
    const u = (d.used||[])[idx] ?? 0;
    document.querySelector(`.pct[data-cat="${c}"]`).value = p;
    document.querySelector(`.used[data-cat="${c}"]`).value = u;
  });
  
  logBox.innerHTML = d.log || '';
  refreshZeroClear();
  computeTotals();
  updateLogsDisplay();
}

document.getElementById('saveBtn').onclick = function() {
  // å„²å­˜ç•¶å‰æœˆä»½çš„æ‰€æœ‰è³‡æ–™
  saveMonth();
  
  // åŒæ™‚ç¢ºä¿è‡ªå®šç¾©æ¬„ä½ä¹Ÿè¢«å„²å­˜
  const key = 'book-'+keyForMonth();
  const data = lsGet(key, {});
  
  ['fixedOut', 'fixedIn', 'saving', 'extraIn', 'extraOut'].forEach(group => {
    const customRows = document.querySelectorAll('#' + group + 'CustomRows tr.' + group + 'Custom');
    const customData = [];
    customRows.forEach(tr => {
      const name = tr.querySelector('.customName')?.value || '';
      const amount = num(tr.querySelector('.moneyZ')?.value || '0');
      if (name.trim() !== '' || amount > 0) {
        customData.push({ name, amount });
      }
    });
    data[group + 'Custom'] = customData;
  });
  
  lsSet(key, data);
  
  // é¡¯ç¤ºå®Œæ•´çš„å„²å­˜æç¤º
  toast('å·²å„²å­˜æ‰€æœ‰è³‡æ–™');
};

const home = document.getElementById('home');
const logs = document.getElementById('logs');
const hidden = document.getElementById('hidden');

document.getElementById('tab-home').onclick=()=>{
  document.body.classList.remove('showLogs', 'showHidden');
  document.getElementById('tab-home').classList.add('active');
  document.getElementById('tab-logs').classList.remove('active');
  document.getElementById('tab-hidden').classList.remove('active');
};

document.getElementById('tab-logs').onclick=()=>{
  document.body.classList.add('showLogs');
  document.body.classList.remove('showHidden');
  document.getElementById('tab-home').classList.remove('active');
  document.getElementById('tab-logs').classList.add('active');
  document.getElementById('tab-hidden').classList.remove('active');
  updateLogsDisplay();
};

document.getElementById('tab-hidden').onclick=()=>{
  document.body.classList.add('showHidden');
  document.body.classList.remove('showLogs');
  document.getElementById('tab-home').classList.remove('active');
  document.getElementById('tab-logs').classList.remove('active');
  document.getElementById('tab-hidden').classList.add('active');
  computeTotals();
};

loadMonth(false);
computeTotals();
updateLogsDisplay();
</script>

<script>
(function(){
  var LOADING = true;
  var DIRTY = false;
  var lastChangeAt = 0;

  // æª¢æŸ¥ localStorage æ˜¯å¦å¯ç”¨
  function checkLocalStorage() {
    try {
      const test = '__storage_test__';
      localStorage.setItem(test, test);
      const result = localStorage.getItem(test);
      localStorage.removeItem(test);
      
      if (result !== test) {
        throw new Error('localStorage è®€å¯«ä¸ä¸€è‡´');
      }
      
      console.log('âœ… localStorage æ­£å¸¸é‹ä½œ');
      return true;
    } catch(e) {
      console.error('âŒ localStorage ä¸å¯ç”¨:', e);
      alert('âš ï¸ è­¦å‘Šï¼šè³‡æ–™å„²å­˜åŠŸèƒ½å¯èƒ½ç„¡æ³•æ­£å¸¸é‹ä½œï¼\n\n' +
            'è«‹ç¢ºèªï¼š\n' +
            '1. ç€è¦½å™¨æœªé–‹å•Ÿã€Œç„¡ç—•æ¨¡å¼ã€\n' +
            '2. ç€è¦½å™¨å…è¨±å„²å­˜è³‡æ–™\n' +
            '3. å„²å­˜ç©ºé–“æœªæ»¿\n\n' +
            'è‹¥ä½¿ç”¨ iOSï¼Œè«‹åˆ°ï¼š\n' +
            'è¨­å®š â†’ Safari â†’ é€²éš â†’ ç¶²ç«™è³‡æ–™\n' +
            'ç¢ºèªæœªå°é–æ­¤ç¶²ç«™');
      return false;
    }
  }

  window.addEventListener('load', function(){ 
    checkLocalStorage();
    setTimeout(function(){ LOADING = false; }, 600); 
  });

  function debounce(fn, wait){
    var t; return function(){ clearTimeout(t); var a=arguments,c=this; t=setTimeout(function(){ fn.apply(c,a); }, wait||400); };
  }

  function markDirty(){
    if (LOADING) return;
    DIRTY = true;
    lastChangeAt = Date.now();
  }

  function silentSave(){
    if (LOADING) return;
    try{
      var orig = window.toast;
      if (typeof window.toast === 'function') window.toast = function(){};
      if (typeof saveMonth === 'function') saveMonth();
      if (orig) window.toast = orig;
      DIRTY = false;
    }catch(e){
      console.warn('autosave failed:', e);
    }
  }
  var debouncedSilentSave = debounce(silentSave, 450);

  var sel = '.pct,.used,.moneyZ,#daysInput,#amountInput,#noteInput,#catSelect,.customName';
  document.addEventListener('input', function(e){
    if (!e.target || !e.target.matches) return;
    if (e.target.matches(sel)) { markDirty(); debouncedSilentSave(); }
  }, {passive:true});
  document.addEventListener('change', function(e){
    if (!e.target || !e.target.matches) return;
    if (e.target.matches(sel)) { markDirty(); debouncedSilentSave(); }
  }, {passive:true});

  document.addEventListener('click', function(){ if (!LOADING) debouncedSilentSave(); }, true);
  document.addEventListener('touchend', function(){ if (!LOADING) debouncedSilentSave(); }, true);

  document.getElementById('okMonth')?.addEventListener('click', function(){ setTimeout(silentSave, 0); });

  window.addEventListener('beforeunload', silentSave);
  window.addEventListener('pagehide', silentSave);
  document.addEventListener('visibilitychange', function(){ if (document.visibilityState === 'hidden') silentSave(); });

  try{
    var candidates = Array.from(document.querySelectorAll('[id*="panel" i],[id*="modal" i],[class*="panel" i],[class*="modal" i]'));
    if (candidates.length){
      var mo = new MutationObserver(function(muts){
        for (var m of muts){
          var el = m.target;
          var styleHidden = (el instanceof HTMLElement) && (getComputedStyle(el).display === 'none' || getComputedStyle(el).visibility === 'hidden' || el.hidden);
          var ariaHidden = (el.getAttribute && el.getAttribute('aria-hidden') === 'true');
          var hasHiddenClass = (el.classList && (el.classList.contains('hidden') || el.classList.contains('is-hidden') || el.classList.contains('collapsed')));
          if (styleHidden || ariaHidden || hasHiddenClass){
            silentSave();
          }
        }
      });
      candidates.forEach(function(el){
        mo.observe(el, {attributes:true, attributeFilter:['style','class','aria-hidden','hidden']});
      });
    }
  }catch(err){ console.warn('observer init failed:', err); }

  setInterval(function(){
    if (DIRTY && Date.now() - lastChangeAt > 2500){
      silentSave();
    }
  }, 1000);
})();
</script>

<script>
(function(){
  var _origCompute = (typeof computeTotals === 'function') ? computeTotals : null;

  function sumByGroup(group){
    var list = document.querySelectorAll('input.moneyZ[data-group="'+group+'"]');
    var s = 0;
    for (var i=0;i<list.length;i++){
      var v = list[i].value;
      var vv = (v==null?"":(""+v)).replace(/[^0-9.+-]/g,"");
      var n = parseFloat(vv);
      if (!isNaN(n)) s += n;
    }
    return s;
  }
  function setText(id, val){
    var el = document.getElementById(id);
    if (!el) return;
    try{
      el.textContent = (Number(val)||0).toLocaleString('zh-TW');
    }catch(e){
      el.textContent = String(val);
    }
  }

  function computeTotals_override(){
    if (_origCompute) {
      try { _origCompute(); } catch(e){}
    }
    var fixedOut = sumByGroup('fixedOut');
    var fixedIn  = sumByGroup('fixedIn');
    var saving   = sumByGroup('saving');
    var extraIn  = sumByGroup('extraIn');
    var extraOut = sumByGroup('extraOut');

    setText('fixedOutTotal', fixedOut);
    setText('fixedInTotal', fixedIn);
    setText('savingTotal',  saving);
    setText('extraInTotal', extraIn);
    if (document.getElementById('extraOutTotal')) setText('extraOutTotal', extraOut);
  }

  window.computeTotals = computeTotals_override;
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', computeTotals_override);
  } else {
    computeTotals_override();
  }

  function bind(){
    document.addEventListener('input', function(e){
      var t=e.target;
      if(t && t.matches && t.matches('.moneyZ')) computeTotals_override();
    }, true);
    document.addEventListener('change', function(e){
      var t=e.target;
      if(t && t.matches && t.matches('.moneyZ')) computeTotals_override();
    }, true);
  }
  bind();
})();
</script>

<script>
function num(v){
  var s = (v == null ? "" : (""+v)).replace(/[^0-9.+-]/g, "");
  var n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}
(function(){
  function recalc(){ try{ computeTotals && computeTotals(); }catch(e){} }
  document.addEventListener('input', function(e){
    var t=e.target; if(!t || !t.matches) return;
    if(t.matches('.moneyZ, .pct, .used, #daysInput')) recalc();
  }, true);
  document.addEventListener('change', function(e){
    var t=e.target; if(!t || !t.matches) return;
    if(t.matches('.moneyZ, .pct, .used, #daysInput')) recalc();
  }, true);
})();
</script>

<script>
(function(){
  function moveReportCards(){
    var hidden = document.getElementById('hidden');
    if(!hidden) return;
    ['rightTable','leftFixedTable','kpiBlock'].forEach(function(id){
      var el = document.getElementById(id);
      if(!el) return;
      var card = el.closest ? el.closest('.card') : null;
      if(card && !hidden.contains(card)) hidden.appendChild(card);
    });
    var cards = Array.prototype.slice.call(document.querySelectorAll('.card'));
    cards.forEach(function(card){
      var title = card.querySelector('.section-title, h2, h3');
      if(!title) return;
      var txt = (title.textContent||'').trim();
      if (txt.indexOf('å…¶ä»–é …ç›®') !== -1 || txt.indexOf('åˆè¨ˆ') !== -1 || txt.indexOf('ä¸»è¦é …ç›®') !== -1) {
        if (!hidden.contains(card)) hidden.appendChild(card);
      }
    });
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){ moveReportCards(); setTimeout(moveReportCards, 50); setTimeout(moveReportCards, 300); });
  } else {
    moveReportCards(); setTimeout(moveReportCards, 50); setTimeout(moveReportCards, 300);
  }
  var th = document.getElementById('tab-home');
  var tl = document.getElementById('tab-logs');
  var tx = document.getElementById('tab-hidden');
  if (th) th.addEventListener('click', moveReportCards);
  if (tx) tx.addEventListener('click', moveReportCards);
})();
</script>

<script>
// ==================== åŒ¯å‡ºåŠŸèƒ½æ¨¡çµ„ ====================
(function(){
  'use strict';
  
  const CATS = ["ç”Ÿæ´»ç”¨å“","ä¼™é£Ÿè²»","å½©å¦ä¿é¤Š","ç´„æœƒåŸºé‡‘","å…¶ä»–æ”¯å‡º","ç¤¾äº¤","å„²è“„"];
  
  // ç”¢ç”Ÿ CSV å…§å®¹ï¼ˆUTF-8 with BOMï¼Œé¿å…äº‚ç¢¼ï¼‰
  function generateCSV(content) {
    const BOM = '\uFEFF'; // UTF-8 BOM
    return BOM + content;
  }
  
  // ä¸‹è¼‰ CSV æª”æ¡ˆ
  function downloadCSV(filename, content) {
    const csvContent = generateCSV(content);
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    URL.revokeObjectURL(url);
  }
  
  // å¾ localStorage ç²å–è³‡æ–™
  function getData(ym) {
    const key = 'book-' + ym;
    try {
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : null;
    } catch(e) {
      console.error('Error loading data:', e);
      return null;
    }
  }
  
  // è§£ææµæ°´å¸³ HTML
  function parseLog(logHtml) {
    if (!logHtml || logHtml.trim() === '') return [];
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = logHtml;
    const items = tempDiv.querySelectorAll('div');
    
    const logs = [];
    items.forEach(item => {
      const text = item.textContent || '';
      // æ ¼å¼: â€¢ 2025/10/23 01:54 ï½œ ç”Ÿæ´»ç”¨å“ ï½œ 888 ï½œ æ´—é¢ä¹³
      const match = text.match(/^â€¢\s*(.+?)\s*ï½œ\s*(.+?)\s*ï½œ\s*(.+?)(?:\s*ï½œ\s*(.+))?$/);
      
      if (match) {
        logs.push({
          datetime: match[1].trim(),
          category: match[2].trim(),
          amount: match[3].trim(),
          note: match[4] ? match[4].trim() : ''
        });
      }
    });
    
    return logs;
  }
  
  // ç”Ÿæˆæµæ°´å¸³ CSV
  function generateLogsCSV(ym) {
    const data = getData(ym);
    if (!data || !data.log) {
      return 'æ™‚é–“,åˆ†é¡,é‡‘é¡,å‚™è¨»\n';
    }
    
    const logs = parseLog(data.log);
    let csv = 'æ™‚é–“,åˆ†é¡,é‡‘é¡,å‚™è¨»\n';
    
    logs.forEach(log => {
      csv += `"${log.datetime}","${log.category}","${log.amount}","${log.note}"\n`;
    });
    
    return csv;
  }
  
  // ç”Ÿæˆå½™ç¸½è¡¨ CSV
  function generateSummaryCSV(ym) {
    const data = getData(ym);
    if (!data) {
      return 'é …ç›®,é‡‘é¡\n';
    }
    
    let csv = 'é …ç›®,é‡‘é¡\n';
    
    // å›ºå®šæ”¯å‡º
    csv += '\nå›ºå®šæ”¯å‡º\n';
    const fixedOutItems = ['ç§Ÿé‡‘', 'ä¿éšªè²»ï¼ˆM&Momï¼‰', 'é›»ä¿¡è²»', 'é›»ï¼ˆ1åº¦5å…ƒï¼‰', 'ä¿¡ç”¨å¡'];
    (data.fixedOut || []).forEach((amount, idx) => {
      if (idx < fixedOutItems.length) {
        csv += `"${fixedOutItems[idx]}","${amount}"\n`;
      }
    });
    
    // å›ºå®šæ”¯å‡ºè‡ªå®šç¾©æ¬„ä½
    if (data.fixedOutCustom && data.fixedOutCustom.length > 0) {
      data.fixedOutCustom.forEach(item => {
        csv += `"${item.name}","${item.amount}"\n`;
      });
    }
    
    const fixedOutTotal = (data.fixedOut || []).reduce((sum, v) => sum + (Number(v) || 0), 0) +
                          (data.fixedOutCustom || []).reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
    csv += `"å›ºå®šæ”¯å‡º Total","${fixedOutTotal}"\n`;
    
    // å›ºå®šæ”¶å…¥
    csv += '\nå›ºå®šæ”¶å…¥\n';
    const fixedInItems = ['JET è–ªè³‡', 'JET çé‡‘', 'SK è–ªè³‡'];
    (data.fixedIn || []).forEach((amount, idx) => {
      if (idx < fixedInItems.length) {
        csv += `"${fixedInItems[idx]}","${amount}"\n`;
      }
    });
    
    // å›ºå®šæ”¶å…¥è‡ªå®šç¾©æ¬„ä½
    if (data.fixedInCustom && data.fixedInCustom.length > 0) {
      data.fixedInCustom.forEach(item => {
        csv += `"${item.name}","${item.amount}"\n`;
      });
    }
    
    const fixedInTotal = (data.fixedIn || []).reduce((sum, v) => sum + (Number(v) || 0), 0) +
                         (data.fixedInCustom || []).reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
    csv += `"å›ºå®šæ”¶å…¥ Total","${fixedInTotal}"\n`;
    
    // å„²è“„
    csv += '\nå„²è“„\n';
    const savingItems = ['å­˜å°éŠ€ï¼ˆå­¸è²»ï¼‰', 'ç¾é‡‘æ›åŒ¯', 'å­˜ç‰å±±', 'æ—…éŠåŸºé‡‘'];
    (data.saving || []).forEach((amount, idx) => {
      if (idx < savingItems.length) {
        csv += `"${savingItems[idx]}","${amount}"\n`;
      }
    });
    
    // å„²è“„è‡ªå®šç¾©æ¬„ä½
    if (data.savingCustom && data.savingCustom.length > 0) {
      data.savingCustom.forEach(item => {
        csv += `"${item.name}","${item.amount}"\n`;
      });
    }
    
    const savingTotal = (data.saving || []).reduce((sum, v) => sum + (Number(v) || 0), 0) +
                        (data.savingCustom || []).reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
    csv += `"å„²è“„ Total","${savingTotal}"\n`;
    
    // é¡å¤–æ”¶å…¥
    csv += '\né¡å¤–æ”¶å…¥\n';
    const extraInItems = ['ç™¼ç¥¨ä¸­ç'];
    (data.extraIn || []).forEach((amount, idx) => {
      if (idx < extraInItems.length) {
        csv += `"${extraInItems[idx]}","${amount}"\n`;
      }
    });
    
    // é¡å¤–æ”¶å…¥è‡ªå®šç¾©æ¬„ä½
    if (data.extraInCustom && data.extraInCustom.length > 0) {
      data.extraInCustom.forEach(item => {
        csv += `"${item.name}","${item.amount}"\n`;
      });
    }
    
    const extraInTotal = (data.extraIn || []).reduce((sum, v) => sum + (Number(v) || 0), 0) +
                         (data.extraInCustom || []).reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
    csv += `"é¡å¤–æ”¶å…¥ Total","${extraInTotal}"\n`;
    
    // é¡å¤–æ”¯å‡º
    csv += '\né¡å¤–æ”¯å‡º\n';
    const extraOutItems = ['æ¬å®¶è²»ç”¨'];
    (data.extraOut || []).forEach((amount, idx) => {
      if (idx < extraOutItems.length) {
        csv += `"${extraOutItems[idx]}","${amount}"\n`;
      }
    });
    
    // é¡å¤–æ”¯å‡ºè‡ªå®šç¾©æ¬„ä½
    if (data.extraOutCustom && data.extraOutCustom.length > 0) {
      data.extraOutCustom.forEach(item => {
        csv += `"${item.name}","${item.amount}"\n`;
      });
    }
    
    const extraOutTotal = (data.extraOut || []).reduce((sum, v) => sum + (Number(v) || 0), 0) +
                          (data.extraOutCustom || []).reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
    csv += `"é¡å¤–æ”¯å‡º Total","${extraOutTotal}"\n`;
    
    // å…¶ä»–é …ç›®
    csv += '\nå…¶ä»–é …ç›®\n';
    csv += 'é …ç›®,ç™¾åˆ†æ¯”,å·²ä½¿ç”¨\n';
    CATS.forEach((cat, idx) => {
      const pct = (data.pct || [])[idx] || 0;
      const used = (data.used || [])[idx] || 0;
      csv += `"${cat}","${pct}%","${used}"\n`;
    });
    
    return csv;
  }
  
  // åŒ¯å‡ºç•¶æœˆè³‡æ–™
  function exportCurrentMonth() {
    // å…ˆå„²å­˜ç•¶å‰é é¢çš„æ‰€æœ‰è³‡æ–™ï¼ˆéœé»˜å„²å­˜ï¼‰
    if (typeof saveMonth === 'function') {
      try {
        const origToast = window.toast;
        window.toast = function(){}; // æš«æ™‚ç¦ç”¨æç¤º
        saveMonth(); // å„²å­˜æ‰€æœ‰è³‡æ–™
        window.toast = origToast;
      } catch(e) {
        console.error('Save before export failed:', e);
      }
    }
    
    const monthInput = document.getElementById('monthInput');
    const ym = monthInput ? monthInput.value : new Date().toISOString().slice(0, 7);
    
    if (!ym) {
      alert('ç„¡æ³•å–å¾—æœˆä»½è³‡è¨Š');
      return;
    }
    
    // ç”Ÿæˆæª”å
    const logFilename = `Belleè¨˜å¸³_æµæ°´å¸³_${ym}.csv`;
    const summaryFilename = `Belleè¨˜å¸³_å½™ç¸½è¡¨_${ym}.csv`;
    
    // ç”Ÿæˆä¸¦ä¸‹è¼‰æµæ°´å¸³
    const logsCSV = generateLogsCSV(ym);
    downloadCSV(logFilename, logsCSV);
    
    // å»¶é²ä¸€é»å†ä¸‹è¼‰å½™ç¸½è¡¨ï¼Œé¿å…åŒæ™‚ä¸‹è¼‰
    setTimeout(() => {
      const summaryCSV = generateSummaryCSV(ym);
      downloadCSV(summaryFilename, summaryCSV);
      
      // è¨˜éŒ„å·²åŒ¯å‡º
      markAsExported(ym);
      
      if (typeof toast === 'function') {
        toast('å·²åŒ¯å‡º ' + ym + ' çš„å®Œæ•´è³‡æ–™');
      } else {
        alert('å·²åŒ¯å‡º ' + ym + ' çš„å®Œæ•´è³‡æ–™');
      }
    }, 500);
  }
  
  // è¨˜éŒ„å·²åŒ¯å‡ºçš„æœˆä»½
  function markAsExported(ym) {
    try {
      const key = 'exported-' + ym;
      localStorage.setItem(key, new Date().toISOString());
    } catch(e) {
      console.error('Failed to mark as exported:', e);
    }
  }
  
  // æª¢æŸ¥æ˜¯å¦å·²åŒ¯å‡º
  function isExported(ym) {
    try {
      const key = 'exported-' + ym;
      return localStorage.getItem(key) !== null;
    } catch(e) {
      return false;
    }
  }
  
  // ç²å–ä¸Šå€‹æœˆçš„å¹´æœˆå­—ä¸²
  function getLastMonth() {
    const now = new Date();
    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    const y = lastMonth.getFullYear();
    const m = String(lastMonth.getMonth() + 1).padStart(2, '0');
    return `${y}-${m}`;
  }
  
  // æª¢æŸ¥æ˜¯å¦æ‡‰è©²è‡ªå‹•åŒ¯å‡º
  function checkAutoExport() {
    const now = new Date();
    const today = now.getDate();
    const hour = now.getHours();
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºæ¯æœˆ 1 è™Ÿçš„å‡Œæ™¨ 0-6 é»
    if (today === 1 && hour >= 0 && hour < 6) {
      const lastMonth = getLastMonth();
      
      // æª¢æŸ¥ä¸Šå€‹æœˆæ˜¯å¦å·²åŒ¯å‡º
      if (!isExported(lastMonth)) {
        // æª¢æŸ¥ä¸Šå€‹æœˆæ˜¯å¦æœ‰è³‡æ–™
        const data = getData(lastMonth);
        if (data && (data.log || data.fixedOut || data.fixedIn)) {
          console.log('Auto-exporting last month:', lastMonth);
          
          // è‡ªå‹•åŒ¯å‡ºä¸Šå€‹æœˆè³‡æ–™
          const logFilename = `Belleè¨˜å¸³_æµæ°´å¸³_${lastMonth}.csv`;
          const summaryFilename = `Belleè¨˜å¸³_å½™ç¸½è¡¨_${lastMonth}.csv`;
          
          const logsCSV = generateLogsCSV(lastMonth);
          downloadCSV(logFilename, logsCSV);
          
          setTimeout(() => {
            const summaryCSV = generateSummaryCSV(lastMonth);
            downloadCSV(summaryFilename, summaryCSV);
            markAsExported(lastMonth);
            
            if (typeof toast === 'function') {
              toast('å·²è‡ªå‹•åŒ¯å‡º ' + lastMonth + ' çš„è³‡æ–™');
            }
          }, 500);
        }
      }
    }
  }
  
  // æª¢æŸ¥å»¶é²åŒ¯å‡ºï¼ˆå•Ÿå‹•æ™‚åŸ·è¡Œï¼‰
  function checkDelayedExport() {
    const now = new Date();
    const today = now.getDate();
    
    // å¦‚æœæ˜¯æ¯æœˆ 1-3 è™Ÿï¼Œæª¢æŸ¥ä¸Šå€‹æœˆæ˜¯å¦å·²åŒ¯å‡º
    if (today >= 1 && today <= 3) {
      const lastMonth = getLastMonth();
      
      if (!isExported(lastMonth)) {
        const data = getData(lastMonth);
        if (data && (data.log || data.fixedOut || data.fixedIn)) {
          // è©¢å•ä½¿ç”¨è€…æ˜¯å¦è¦åŒ¯å‡ºä¸Šå€‹æœˆè³‡æ–™
          const shouldExport = confirm(`åµæ¸¬åˆ° ${lastMonth} çš„è³‡æ–™å°šæœªåŒ¯å‡ºï¼Œæ˜¯å¦è¦ç¾åœ¨åŒ¯å‡ºï¼Ÿ`);
          
          if (shouldExport) {
            const logFilename = `Belleè¨˜å¸³_æµæ°´å¸³_${lastMonth}.csv`;
            const summaryFilename = `Belleè¨˜å¸³_å½™ç¸½è¡¨_${lastMonth}.csv`;
            
            const logsCSV = generateLogsCSV(lastMonth);
            downloadCSV(logFilename, logsCSV);
            
            setTimeout(() => {
              const summaryCSV = generateSummaryCSV(lastMonth);
              downloadCSV(summaryFilename, summaryCSV);
              markAsExported(lastMonth);
              
              if (typeof toast === 'function') {
                toast('å·²åŒ¯å‡º ' + lastMonth + ' çš„è³‡æ–™');
              }
            }, 500);
          }
        }
      }
    }
  }
  
  // æ‰‹å‹•åŒ¯å‡ºæŒ‰éˆ•äº‹ä»¶
  const exportBtn = document.getElementById('exportBtn');
  if (exportBtn) {
    exportBtn.addEventListener('click', exportCurrentMonth);
  }
  
  // é é¢è¼‰å…¥æ™‚åŸ·è¡Œæª¢æŸ¥
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(checkDelayedExport, 1000);
    });
  } else {
    setTimeout(checkDelayedExport, 1000);
  }
  
  // æ¯å¤©å‡Œæ™¨ 00:01 æª¢æŸ¥ä¸€æ¬¡ï¼ˆå¦‚æœé é¢æŒçºŒé–‹è‘—ï¼‰
  function scheduleNextCheck() {
    const now = new Date();
    const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 1, 0);
    const msUntilMidnight = tomorrow.getTime() - now.getTime();
    
    setTimeout(function() {
      checkAutoExport();
      scheduleNextCheck(); // æ’ç¨‹ä¸‹ä¸€æ¬¡æª¢æŸ¥
    }, msUntilMidnight);
  }
  
  scheduleNextCheck();
  
  // ä¹Ÿåœ¨å•Ÿå‹•æ™‚ç«‹å³æª¢æŸ¥ä¸€æ¬¡
  setTimeout(checkAutoExport, 2000);
  
  console.log('Export module loaded');
})();

// ============================================
// PWA Service Worker è¨»å†Š
// ============================================
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
      .then(registration => {
        console.log('âœ… Service Worker è¨»å†ŠæˆåŠŸ:', registration.scope);
      })
      .catch(error => {
        console.log('âŒ Service Worker è¨»å†Šå¤±æ•—:', error);
      });
  });
}

// å®‰è£æç¤º
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  console.log('ğŸ’¡ å¯ä»¥å®‰è£ PWA äº†ï¼');
});
</script>

</body>
</html>
